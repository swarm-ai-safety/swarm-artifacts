# SWARM Research OS â€” Auto-synthesize new runs
#
# When new run data is pushed to main (e.g. from a SWARM experiment),
# detect which runs lack vault notes and synthesize them.
# Opens a PR with the generated vault notes.

name: Synthesize runs

on:
  push:
    branches: [main]
    paths:
      - "runs/**/run.yaml"
      - "runs/**/summary.json"
      - "runs/**/report.json"

jobs:
  synthesize:
    name: Synthesize new runs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # need parent commit for diff

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install pyyaml jsonschema

      - name: Detect new runs
        id: detect
        run: |
          # Find run.yaml files added or modified in this push
          NEW_RUNS=$(git diff --name-only HEAD~1 HEAD -- 'runs/*/run.yaml' | while read f; do
            RUN_ID=$(basename $(dirname "$f"))
            # Check if experiment note already exists
            if [ ! -f "vault/experiments/${RUN_ID}.md" ]; then
              echo "$RUN_ID"
            fi
          done)

          if [ -z "$NEW_RUNS" ]; then
            echo "No new unsynthesized runs detected"
            echo "has_runs=false" >> "$GITHUB_OUTPUT"
          else
            echo "New runs to synthesize:"
            echo "$NEW_RUNS"
            echo "has_runs=true" >> "$GITHUB_OUTPUT"
            # Save as multiline output
            {
              echo "run_ids<<EOF"
              echo "$NEW_RUNS"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Backfill missing run.yaml
        if: steps.detect.outputs.has_runs == 'true'
        run: python scripts/backfill-run-yaml.py

      - name: Validate new runs
        if: steps.detect.outputs.has_runs == 'true'
        run: |
          echo "${{ steps.detect.outputs.run_ids }}" | while read RUN_ID; do
            [ -z "$RUN_ID" ] && continue
            python scripts/validate-run.py "runs/$RUN_ID"
          done

      - name: Rebuild run index
        if: steps.detect.outputs.has_runs == 'true'
        run: python scripts/index-runs.py

      - name: Generate experiment notes
        if: steps.detect.outputs.has_runs == 'true'
        run: |
          echo "${{ steps.detect.outputs.run_ids }}" | while read RUN_ID; do
            [ -z "$RUN_ID" ] && continue
            echo "Synthesizing: $RUN_ID"
            python scripts/generate-note.py "$RUN_ID" || echo "::warning::Failed to synthesize $RUN_ID"
          done

      - name: Check for vault changes
        if: steps.detect.outputs.has_runs == 'true'
        id: changes
        run: |
          if git diff --quiet vault/ run-index.yaml; then
            echo "No vault changes produced"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            CHANGED=$(git diff --name-only vault/ run-index.yaml | wc -l | tr -d ' ')
            echo "$CHANGED files changed in vault"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "changed_count=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      - name: Create synthesis PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "SWARM Research OS"
          git config user.email "noreply@swarm-ai-safety.org"
          BRANCH="research-os/synthesize-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add vault/ run-index.yaml
          git commit -m "Synthesize new runs into vault notes

          Auto-generated experiment notes for:
          ${{ steps.detect.outputs.run_ids }}

          Co-Authored-By: SWARM Research OS <noreply@swarm-ai-safety.org>"

          git push -u origin "$BRANCH"

          RUN_LIST=$(echo "${{ steps.detect.outputs.run_ids }}" | sed 's/^/- /')
          gh pr create \
            --title "Synthesize $(echo "${{ steps.detect.outputs.run_ids }}" | wc -l | tr -d ' ') new run(s)" \
            --body "## Summary

          Auto-synthesized experiment notes for new runs pushed to main.

          ### Runs synthesized
          ${RUN_LIST}

          ### Files changed
          - ${{ steps.changes.outputs.changed_count }} vault files updated
          - run-index.yaml rebuilt

          ---
          *Auto-generated by SWARM Research OS*" \
            --label "synthesis,automated"
